================================================================================
DESPLIEGUE DE CONTRATOS EN POLYGON AMOY TESTNET
================================================================================

FECHA: 2025-12-08
VERSI√ìN: Contratos con correcciones de distribuci√≥n de pagos a sponsors

================================================================================
DIRECCIONES DE CONTRATOS DESPLEGADOS
================================================================================

üìç DIRECCIONES PROXY (usar en frontend y transacciones):
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Sponsors Contract:
   Proxy:          0x537f0E3593693E41481d921C0a7546f12a2ca874
   Implementation: 0xf41c8FFdbC13b6F672eb3332634c4BE6A59C8CFB
   PolygonScan:    https://amoy.polygonscan.com/address/0x537f0E3593693E41481d921C0a7546f12a2ca874

LotteryFactoryMiddleware Contract:
   Proxy:          0x3c58A7fC3bfaC40Cc34BE02766D6E39f917ed0cb
   Implementation: 0x850149e6FEe12Ce0E105490Ab37c1DCd51245fCb
   PolygonScan:    https://amoy.polygonscan.com/address/0x3c58A7fC3bfaC40Cc34BE02766D6E39f917ed0cb

LotteryFactory Contract:
   Proxy:          0x971eD8Db6e6d002c38AEfF46F273e8f9961aA013
   Implementation: 0x96A2c59f83b2200E150439435D37d5D028B4a755
   PolygonScan:    https://amoy.polygonscan.com/address/0x971eD8Db6e6d002c38AEfF46F273e8f9961aA013


================================================================================
ESTADO DE VERIFICACI√ìN EN POLYGONSCAN
================================================================================

‚úÖ Sponsors:    VERIFICADO
‚úÖ Middleware:  VERIFICADO
‚úÖ Factory:     VERIFICADO

Todos los contratos est√°n verificados y el c√≥digo fuente es visible en PolygonScan.


================================================================================
CORRECCIONES INCLUIDAS EN ESTE DESPLIEGUE
================================================================================

Este despliegue incluye las correcciones cr√≠ticas en LotteryTemplate.sol:

BUG #1 CORREGIDO: C√°lculo incorrecto de porcentajes
- ANTES: Modificaba _totalCost en cada iteraci√≥n
- AHORA: Usa _originalCost constante para calcular siempre 25%

BUG #2 CORREGIDO: Permit√≠a 3 sponsors en lugar de 2
- ANTES: Loop de 0 a 3 (3 iteraciones)
- AHORA: Loop de 1 a 3 (2 iteraciones, √≠ndices 1 y 2)

BUG #3 CORREGIDO: No verificaba si el sponsor estaba activo
- ANTES: Transfer√≠a a cualquier sponsor registrado
- AHORA: Solo transfiere a sponsors activos


================================================================================
DISTRIBUCI√ìN DE PAGOS (CORREGIDA)
================================================================================

Cuando un usuario compra boxes, la distribuci√≥n es:

CON 2 SPONSORS ACTIVOS:
- Sponsor Directo:    25% del precio total
- Sponsor Indirecto:  25% del precio total
- Contrato Loter√≠a:   50% del precio total

CON 1 SPONSOR ACTIVO:
- Sponsor Activo:     25% del precio total
- Contrato Loter√≠a:   75% del precio total

SIN SPONSORS ACTIVOS:
- Contrato Loter√≠a:   100% del precio total


================================================================================
CONFIGURACI√ìN DEL FRONTEND
================================================================================

El archivo frontend/src/app/services/web3.ts ha sido actualizado con las nuevas
direcciones de contratos:

export const CONTRACTS = {
  MIDDLEWARE: '0x3c58A7fC3bfaC40Cc34BE02766D6E39f917ed0cb',
  FACTORY: '0x971eD8Db6e6d002c38AEfF46F273e8f9961aA013',
  SPONSORS: '0x537f0E3593693E41481d921C0a7546f12a2ca874',
  TEMPLATE: '0x55b59889baB20D84FdB1D5f4aAd09e1B2aAc2985'
};


================================================================================
INFORMACI√ìN DE DESPLIEGUE
================================================================================

Red:               Polygon Amoy Testnet
Chain ID:          80002
Cuenta Deployer:   0x5B73375A952Ac9Ef19983f3D4F81263B67488C51
Balance usado:     ~0.02 MATIC (gas fees)
Timestamp:         2025-12-08 22:00:00 (aproximado)


================================================================================
COMANDOS √öTILES
================================================================================

VERIFICAR CONTRATOS MANUALMENTE:
npx hardhat verify --network polygon_amoy 0xf41c8FFdbC13b6F672eb3332634c4BE6A59C8CFB
npx hardhat verify --network polygon_amoy 0x850149e6FEe12Ce0E105490Ab37c1DCd51245fCb
npx hardhat verify --network polygon_amoy 0x96A2c59f83b2200E150439435D37d5D028B4a755

EJECUTAR TESTS:
npx hardhat test test/SponsorDistribution.test.js

INICIAR FRONTEND:
cd frontend
npm start


================================================================================
PR√ìXIMOS PASOS
================================================================================

1. ‚úÖ Contratos desplegados
2. ‚úÖ Contratos verificados en PolygonScan
3. ‚úÖ Frontend actualizado con nuevas direcciones
4. üîÑ Probar funcionalidad en el frontend:
   - Conectar wallet
   - Crear loter√≠a de prueba
   - Registrar usuarios con sponsors
   - Comprar boxes y verificar distribuci√≥n de pagos

5. üìä Monitorear transacciones en PolygonScan para confirmar distribuci√≥n correcta


================================================================================
ENLACES IMPORTANTES
================================================================================

PolygonScan Amoy:
https://amoy.polygonscan.com/

Frontend Local:
http://localhost:4200/

Documentaci√≥n de Correcciones:
Ver archivo: escenarios_distribucion_sponsors.txt


================================================================================
NOTAS IMPORTANTES
================================================================================

‚ö†Ô∏è IMPORTANTE: Estos contratos est√°n en la red de PRUEBA Amoy. No usar en mainnet
sin pruebas exhaustivas adicionales.

‚úÖ Los contratos implementan las correcciones de distribuci√≥n de pagos a sponsors
que fueron verificadas con 6 tests automatizados exitosos.

‚úÖ La distribuci√≥n de pagos ahora funciona correctamente con cualquier precio de
box configurado en la loter√≠a (1 USD, 10 USD, 100 USD, etc.).

‚úÖ Solo los sponsors ACTIVOS en una loter√≠a espec√≠fica reciben comisiones.


================================================================================
FIN DEL DOCUMENTO
================================================================================
